## 目录结构

```
http-studio/
  app.py
  requirements.txt
  core/
    __init__.py
    curl_parser.py
    security.py
    sender.py
    response_store.py
  templates/
    index.html
  static/
    app.css
    app.js
```

---

## requirements.txt

```txt
flask>=2.3
requests>=2.31
```

---

## app.py

```python
from flask import Flask, render_template, request, jsonify
from core.curl_parser import parse_curl_bash
from core.sender import send_http_request
from core.response_store import response_store

app = Flask(__name__)
app.config["MAX_CONTENT_LENGTH"] = 50 * 1024 * 1024  # 50MB


@app.get("/")
def index():
    return render_template("index.html")


@app.post("/api/parse_curl")
def api_parse_curl():
    data = request.get_json(silent=True) or {}
    curl = data.get("curl", "")
    try:
        parsed = parse_curl_bash(curl)
        return jsonify(parsed)
    except Exception as e:
        return jsonify({"error": str(e)}), 400


@app.post("/api/send")
def api_send():
    """
    Receives multipart/form-data (for file uploads) + fields.
    Returns response JSON (headers/body/text/json) and a download_id for binary download.
    """
    form = {
        "method": request.form.get("method", "GET"),
        "url": request.form.get("url", ""),
        "query_params": request.form.get("query_params", ""),
        "headers": request.form.get("headers", ""),
        "body_mode": request.form.get("body_mode", "none"),
        "body_text": request.form.get("body_text", ""),
        "timeout": request.form.get("timeout", 20),
        "verify_ssl": request.form.get("verify_ssl", "true"),
        "allow_redirects": request.form.get("allow_redirects", "true"),
        "proxy": request.form.get("proxy", ""),
        "auth_user": request.form.get("auth_user", ""),
        "cookies": request.form.get("cookies", ""),
    }

    try:
        resp = send_http_request(form, request.files)
        # store raw bytes for download (short TTL)
        download_id = response_store.put(resp.get("_raw_bytes", b""), resp.get("content_type", "application/octet-stream"))
        resp["download_id"] = download_id
        # do not return raw bytes in JSON
        resp.pop("_raw_bytes", None)
        return jsonify(resp)
    except Exception as e:
        return jsonify({"error": str(e)}), 400


@app.get("/api/download/<download_id>")
def api_download(download_id: str):
    item = response_store.get(download_id)
    if not item:
        return jsonify({"error": "下载已过期或不存在"}), 404

    raw, content_type = item
    # Note: flask Response without importing Response directly
    from flask import Response
    return Response(raw, mimetype=content_type, headers={
        "Content-Disposition": f'attachment; filename="response_{download_id}"'
    })


if __name__ == "__main__":
    # http://127.0.0.1:5000
    app.run(host="127.0.0.1", port=5000, debug=True)
```

---

## core/**init**.py

```python
# empty
```

---

## core/security.py

```python
import socket
import ipaddress
from urllib.parse import urlparse

PRIVATE_NETS = [
    ipaddress.ip_network("127.0.0.0/8"),
    ipaddress.ip_network("10.0.0.0/8"),
    ipaddress.ip_network("172.16.0.0/12"),
    ipaddress.ip_network("192.168.0.0/16"),
    ipaddress.ip_network("169.254.0.0/16"),
    ipaddress.ip_network("::1/128"),
    ipaddress.ip_network("fc00::/7"),
    ipaddress.ip_network("fe80::/10"),
]

DEFAULT_ALLOWED_PORTS = {80, 443}


def _is_ip_public(ip: ipaddress._BaseAddress) -> bool:
    return not any(ip in n for n in PRIVATE_NETS)


def resolve_all_ips(hostname: str):
    infos = socket.getaddrinfo(hostname, None)
    ips = []
    for _, _, _, _, sockaddr in infos:
        ip_str = sockaddr[0]
        try:
            ips.append(ipaddress.ip_address(ip_str))
        except ValueError:
            pass
    return ips


def validate_public_url(url: str, allowed_ports=None) -> tuple[bool, str]:
    """
    Strong SSRF guard:
    - only http/https
    - hostname must resolve to public IPs
    - port must be in allowlist (default 80/443)
    - blocks localhost, *.local, single-label host
    """
    allowed_ports = allowed_ports or DEFAULT_ALLOWED_PORTS
    try:
        p = urlparse(url)
        if p.scheme not in ("http", "https"):
            return False, "仅允许 http/https URL"
        if not p.hostname:
            return False, "URL 缺少 hostname"
        host = p.hostname.strip().lower()

        # block obvious local names
        if host in ("localhost",):
            return False, "禁止访问 localhost"
        if host.endswith(".local"):
            return False, "禁止访问 .local 域"
        if "." not in host:
            return False, "禁止无点域名（单标签主机名）"

        port = p.port
        if port is None:
            port = 443 if p.scheme == "https" else 80
        if port not in allowed_ports:
            return False, f"端口 {port} 不在允许列表（{sorted(allowed_ports)}）"

        # if direct IP
        try:
            ip = ipaddress.ip_address(host)
            if not _is_ip_public(ip):
                return False, "禁止访问内网/保留网段 IP"
            return True, ""
        except ValueError:
            pass

        ips = resolve_all_ips(host)
        if not ips:
            return False, "DNS 解析失败"
        if not all(_is_ip_public(ip) for ip in ips):
            return False, "DNS 解析到内网/保留网段地址，已阻止"

        return True, ""
    except Exception as e:
        return False, f"URL 校验失败：{e}"
```

---

## core/response_store.py

```python
import time
import secrets

class ResponseStore:
    """
    Small in-memory store for raw responses to support download button.
    TTL default: 5 minutes.
    """
    def __init__(self, ttl_seconds=300, max_items=100):
        self.ttl = ttl_seconds
        self.max_items = max_items
        self._store = {}  # id -> (expire_ts, raw_bytes, content_type)

    def put(self, raw: bytes, content_type: str) -> str:
        self._cleanup()
        if len(self._store) >= self.max_items:
            self._cleanup(force=True)
        rid = secrets.token_urlsafe(10)
        self._store[rid] = (time.time() + self.ttl, raw or b"", content_type or "application/octet-stream")
        return rid

    def get(self, rid: str):
        self._cleanup()
        item = self._store.get(rid)
        if not item:
            return None
        exp, raw, ct = item
        if time.time() > exp:
            self._store.pop(rid, None)
            return None
        return raw, ct

    def _cleanup(self, force=False):
        now = time.time()
        # remove expired
        expired = [k for k, (exp, _, __) in self._store.items() if exp < now]
        for k in expired:
            self._store.pop(k, None)
        if force and self._store:
            # remove oldest
            keys = list(self._store.keys())
            for k in keys[: max(1, len(keys)//3)]:
                self._store.pop(k, None)

response_store = ResponseStore()
```

---

## core/curl_parser.py

```python
import re
import shlex
from urllib.parse import urlparse, parse_qsl, urlunparse

def _strip_query(url: str):
    p = urlparse(url)
    pairs = list(parse_qsl(p.query, keep_blank_values=True))
    url_no_query = urlunparse((p.scheme, p.netloc, p.path, p.params, "", p.fragment))
    return url_no_query, pairs

def _add_header(headers: dict, line: str):
    if ":" in line:
        k, v = line.split(":", 1)
        headers[k.strip()] = v.strip()

def parse_curl_bash(curl_text: str) -> dict:
    """
    Best-effort parser for DevTools Copy as cURL (bash).
    Returns a normalized request object for UI.
    """
    if not curl_text or "curl" not in curl_text:
        raise ValueError("未检测到 curl 命令（请粘贴 DevTools 的 Copy as cURL (bash)）。")

    t = curl_text.strip()
    t = re.sub(r"^\s*\$\s+", "", t)
    t = t.replace("\\\n", " ")

    try:
        tokens = shlex.split(t, posix=True)
    except Exception as e:
        raise ValueError(f"curl 解析失败（shlex）：{e}")

    curl_idx = 0
    for i, tok in enumerate(tokens):
        if tok == "curl" or tok.endswith("/curl"):
            curl_idx = i
            break
    tokens = tokens[curl_idx + 1 :]

    method = None
    urls = []
    headers = {}
    cookies = ""
    auth_user = ""
    proxy = ""
    follow_redirects = True
    insecure = False
    timeout = 20
    use_get_flag = False
    head_only = False

    data_chunks = []
    data_urlencode_chunks = []
    form_chunks = []
    compressed = False

    i = 0
    while i < len(tokens):
        tok = tokens[i]

        if tok.startswith("http://") or tok.startswith("https://"):
            urls.append(tok); i += 1; continue
        if tok == "--url" and i + 1 < len(tokens):
            urls.append(tokens[i + 1]); i += 2; continue

        if tok in ("-X", "--request") and i + 1 < len(tokens):
            method = tokens[i + 1].upper(); i += 2; continue

        if tok in ("-H", "--header") and i + 1 < len(tokens):
            _add_header(headers, tokens[i + 1]); i += 2; continue

        if tok in ("-b", "--cookie") and i + 1 < len(tokens):
            cookies = tokens[i + 1]; i += 2; continue

        if tok in ("-u", "--user") and i + 1 < len(tokens):
            auth_user = tokens[i + 1]; i += 2; continue

        if tok in ("-x", "--proxy") and i + 1 < len(tokens):
            proxy = tokens[i + 1]; i += 2; continue

        if tok in ("-L", "--location", "--location-trusted"):
            follow_redirects = True; i += 1; continue

        if tok in ("-k", "--insecure"):
            insecure = True; i += 1; continue

        if tok in ("-m", "--max-time") and i + 1 < len(tokens):
            try:
                timeout = int(float(tokens[i + 1]))
            except Exception:
                pass
            i += 2; continue

        if tok in ("-G", "--get"):
            use_get_flag = True; i += 1; continue

        if tok in ("-I", "--head"):
            head_only = True; i += 1; continue

        if tok in ("-d", "--data", "--data-raw", "--data-binary") and i + 1 < len(tokens):
            data_chunks.append(tokens[i + 1]); i += 2; continue

        if tok == "--data-urlencode" and i + 1 < len(tokens):
            data_urlencode_chunks.append(tokens[i + 1]); i += 2; continue

        if tok == "--json" and i + 1 < len(tokens):
            headers.setdefault("Content-Type", "application/json")
            data_chunks.append(tokens[i + 1])
            if not method:
                method = "POST"
            i += 2; continue

        if tok in ("-F", "--form") and i + 1 < len(tokens):
            form_chunks.append(tokens[i + 1]); i += 2; continue

        if tok == "--compressed":
            compressed = True; i += 1; continue

        i += 1

    if not urls:
        raise ValueError("未解析到 URL（请确认 curl 中包含 https://...）。")

    url = urls[0]
    url, url_q = _strip_query(url)
    query_pairs = list(url_q)

    if cookies and "Cookie" not in headers:
        headers["Cookie"] = cookies
    if compressed and "Accept-Encoding" not in headers:
        headers["Accept-Encoding"] = "gzip, deflate, br"

    if head_only:
        method = "HEAD"
    if not method:
        method = "POST" if (form_chunks or data_chunks or data_urlencode_chunks) else "GET"
    if use_get_flag:
        method = "GET"

    body_mode = "none"
    body_text = ""

    if form_chunks:
        body_mode = "multipart"
        body_text = "\n".join(form_chunks)
    else:
        if data_urlencode_chunks:
            pairs = []
            for item in data_urlencode_chunks:
                if "=" in item:
                    k, v = item.split("=", 1)
                    pairs.append((k, v))
                else:
                    pairs.append((item, ""))
            if use_get_flag:
                query_pairs.extend(pairs)
            else:
                body_mode = "form-urlencoded"
                body_text = "\n".join([f"{k}={v}" for k, v in pairs])

        if data_chunks:
            raw = "&".join(data_chunks).strip()
            if use_get_flag:
                pairs = []
                for part in raw.split("&"):
                    if "=" in part:
                        k, v = part.split("=", 1)
                        pairs.append((k, v))
                    elif part:
                        pairs.append((part, ""))
                query_pairs.extend(pairs)
            else:
                if raw.startswith("{") or raw.startswith("["):
                    body_mode = "json"; body_text = raw
                else:
                    if "&" in raw and "=" in raw and "\n" not in raw:
                        body_mode = "form-urlencoded"
                        body_text = "\n".join([p for p in raw.split("&") if p])
                    else:
                        body_mode = "raw"; body_text = raw

    return {
        "method": method,
        "url": url,
        "query_pairs": query_pairs,   # array of [k,v]
        "headers": headers,           # dict
        "cookies": cookies or "",
        "auth_user": auth_user or "",
        "proxy": proxy or "",
        "follow_redirects": bool(follow_redirects),
        "insecure": bool(insecure),
        "timeout": int(max(1, min(int(timeout), 120))),
        "body_mode": body_mode,
        "body_text": body_text,
    }
```

---

## core/sender.py

```python
import json
from urllib.parse import urlparse, parse_qsl, urlencode, urlunparse
import requests

from .security import validate_public_url

MAX_PREVIEW_BYTES = 2 * 1024 * 1024  # 2MB for preview (UI shows text), raw bytes stored for download


def parse_kv_text(text: str):
    out = []
    for line in (text or "").splitlines():
        line = line.strip()
        if not line or line.startswith("#"):
            continue
        if "=" in line:
            k, v = line.split("=", 1)
            out.append((k.strip(), v.strip()))
        else:
            out.append((line.strip(), ""))
    return out

def parse_headers_text(text: str):
    out = {}
    for line in (text or "").splitlines():
        line = line.strip()
        if not line or line.startswith("#"):
            continue
        if ":" not in line:
            continue
        k, v = line.split(":", 1)
        out[k.strip()] = v.strip()
    return out

def merge_query(url: str, extra_pairs):
    p = urlparse(url)
    q = list(parse_qsl(p.query, keep_blank_values=True))
    q.extend(extra_pairs or [])
    new_query = urlencode(q, doseq=True)
    return urlunparse((p.scheme, p.netloc, p.path, p.params, new_query, p.fragment))

def build_multipart_from_text(body_text: str, uploaded_files):
    fields = {}
    files = {}
    for k, v in parse_kv_text(body_text):
        if not k:
            continue
        if v.startswith("@"):
            f = uploaded_files.get(k)
            if f and getattr(f, "filename", ""):
                files[k] = (f.filename, f.stream, f.mimetype or "application/octet-stream")
            else:
                fields[k] = v
        else:
            fields[k] = v
    return fields, files

def _safe_check_redirects(resp: requests.Response, allowed_ports=None):
    """
    After redirects are followed by requests, validate the final URL again to prevent redirect-to-internal.
    """
    final_url = str(resp.url)
    ok, msg = validate_public_url(final_url, allowed_ports=allowed_ports)
    if not ok:
        raise ValueError(f"重定向后的最终地址被安全策略阻止：{msg}")

def send_http_request(form, uploaded_files):
    method = (form.get("method") or "GET").upper().strip()
    url = (form.get("url") or "").strip()

    ok, msg = validate_public_url(url)
    if not ok:
        raise ValueError(msg)

    headers = parse_headers_text(form.get("headers", ""))
    query_pairs = parse_kv_text(form.get("query_params", ""))
    url = merge_query(url, query_pairs)

    timeout = int(float(form.get("timeout") or 20))
    timeout = max(1, min(timeout, 120))
    verify_ssl = (form.get("verify_ssl") or "true").lower() == "true"
    allow_redirects = (form.get("allow_redirects") or "true").lower() == "true"

    proxy = (form.get("proxy") or "").strip()
    proxies = {"http": proxy, "https": proxy} if proxy else None

    auth_user = (form.get("auth_user") or "").strip()
    auth = None
    if auth_user and ":" in auth_user:
        u, p = auth_user.split(":", 1)
        auth = (u, p)

    cookies = (form.get("cookies") or "").strip()
    if cookies and "Cookie" not in headers:
        headers["Cookie"] = cookies

    body_mode = (form.get("body_mode") or "none").strip()
    body_text = form.get("body_text", "") or ""

    req_kwargs = dict(
        method=method,
        url=url,
        headers=headers if headers else None,
        timeout=timeout,
        verify=verify_ssl,
        allow_redirects=allow_redirects,
        proxies=proxies,
        auth=auth,
        stream=True,  # stream so we can limit preview bytes
    )

    if body_mode == "none" or not body_text:
        pass
    elif body_mode == "json":
        try:
            req_kwargs["json"] = json.loads(body_text)
        except Exception as e:
            raise ValueError(f"JSON 解析失败：{e}")
    elif body_mode == "form-urlencoded":
        req_kwargs["data"] = dict(parse_kv_text(body_text))
    elif body_mode == "multipart":
        fields, files = build_multipart_from_text(body_text, uploaded_files)
        if files:
            req_kwargs["data"] = fields
            req_kwargs["files"] = files
        else:
            req_kwargs["files"] = {k: (None, v) for k, v in fields.items()}
    elif body_mode == "raw":
        raw_file = uploaded_files.get("__raw_file__")
        if raw_file and getattr(raw_file, "filename", ""):
            req_kwargs["data"] = raw_file.read()
            if req_kwargs.get("headers") is None:
                req_kwargs["headers"] = {}
            if "Content-Type" not in req_kwargs["headers"] and raw_file.mimetype:
                req_kwargs["headers"]["Content-Type"] = raw_file.mimetype
        else:
            req_kwargs["data"] = body_text.encode("utf-8")
    else:
        raise ValueError("未知 body_mode。")

    r = requests.request(**req_kwargs)

    # validate final redirect target
    if allow_redirects:
        _safe_check_redirects(r)

    # read bytes (preview limited)
    raw = b""
    total = 0
    for chunk in r.iter_content(chunk_size=64 * 1024):
        if not chunk:
            continue
        raw += chunk
        total += len(chunk)
        if total >= MAX_PREVIEW_BYTES:
            break

    # Also try to read remainder for download? (would defeat streaming limit)
    # We store only preview bytes for download. If you need full raw download, remove the limit.
    # (Keeping it safe to prevent memory blow-ups.)
    content_type = (r.headers.get("Content-Type") or "application/octet-stream").split(";")[0].strip()

    headers_text = "\n".join([f"{k}: {v}" for k, v in r.headers.items()])

    # body preview as text
    body_text_out = ""
    try:
        # best effort decode
        body_text_out = raw.decode(r.encoding or "utf-8", errors="replace")
    except Exception:
        body_text_out = raw.decode("utf-8", errors="replace")

    # pretty JSON if content-type indicates json
    if "application/json" in (r.headers.get("Content-Type") or "").lower():
        try:
            body_text_out = json.dumps(r.json(), ensure_ascii=False, indent=2)
        except Exception:
            pass

    return {
        "ok": bool(r.ok),
        "status_code": int(r.status_code),
        "reason": r.reason,
        "final_url": str(r.url),
        "elapsed_ms": int(getattr(r.elapsed, "total_seconds", lambda: 0)() * 1000),
        "body_len": int(r.headers.get("Content-Length") or len(raw)),
        "content_type": content_type,
        "headers_text": headers_text,
        "body_text": body_text_out,
        "_raw_bytes": raw,
        "truncated": total >= MAX_PREVIEW_BYTES,
    }
```

---

## templates/index.html

```html
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>HTTP Studio</title>
  <link rel="stylesheet" href="/static/app.css">
</head>
<body>
<header class="header">
  <div class="wrap topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div class="brand-title">HTTP Studio</div>
        <div class="hint">粘贴 cURL → 解析 → 预设改参 → 发送（移动端抽屉响应）</div>
      </div>
    </div>
    <div class="hint right-hint">本地历史/收藏/预设都在浏览器 localStorage（服务端不落盘）</div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- Left -->
    <section class="card">
      <div class="card-hd">
        <div class="title">cURL (bash) 解析</div>
        <div class="pill">DevTools Copy as cURL</div>
      </div>
      <div class="card-body">
        <label>粘贴 cURL</label>
        <textarea id="curlText" placeholder="curl 'https://...' -H '...' --data-raw '...'"></textarea>

        <div class="btns">
          <button class="secondary" id="btnExample">示例</button>
          <button id="btnParse">解析</button>
        </div>
        <div id="parseMsg" class="msg"></div>

        <hr class="sep">
        <div class="row">
          <input id="historySearch" placeholder="搜索历史/收藏（按 URL/Method/时间/标签）" />
        </div>
        <div class="btns">
          <button class="secondary" id="btnSaveStar">⭐ 收藏当前</button>
          <button class="secondary" id="btnSaveHistory">保存到历史</button>
          <button class="danger" id="btnClearHistory">清空历史</button>
        </div>
        <div id="historyList" class="list"></div>
      </div>
    </section>

    <!-- Right -->
    <section class="card">
      <div class="card-hd">
        <div class="title">请求编辑器</div>
        <div class="tabs">
          <button class="tab active" data-tab="req">Request</button>
          <button class="tab" data-tab="presets">Presets</button>
          <button class="tab" data-tab="adv">Advanced</button>
        </div>
      </div>

      <div class="card-body">
        <!-- Request tab -->
        <div class="tabpane" id="tab-req">
          <div class="row">
            <div class="col-160">
              <label>Method</label>
              <select id="method">
                <option>GET</option><option>POST</option><option>PUT</option><option>PATCH</option>
                <option>DELETE</option><option>HEAD</option><option>OPTIONS</option>
              </select>
            </div>
            <div class="col-flex">
              <label>URL</label>
              <input id="url" placeholder="https://httpbin.org/anything" />
            </div>
          </div>

          <div class="split">
            <div>
              <label>Query（可视化）</label>
              <div class="kv" id="kvQuery"></div>
              <div class="btns">
                <button class="secondary" id="qAdd">+ Add</button>
                <button class="secondary" id="qSync">同步文本</button>
              </div>
              <label>Query（文本 key=value）</label>
              <textarea id="queryText"></textarea>
              <button class="secondary full" id="qImport">从文本导入</button>
            </div>

            <div>
              <label>Headers（可视化）</label>
              <div class="kv" id="kvHeaders"></div>
              <div class="btns">
                <button class="secondary" id="hAdd">+ Add</button>
                <button class="secondary" id="hSync">同步文本</button>
              </div>
              <label>Headers（文本 Key: Value）</label>
              <textarea id="headersText"></textarea>
              <button class="secondary full" id="hImport">从文本导入</button>
            </div>
          </div>

          <label>Body 类型</label>
          <select id="bodyMode">
            <option value="none">none</option>
            <option value="json">json</option>
            <option value="form-urlencoded">form-urlencoded</option>
            <option value="multipart">multipart</option>
            <option value="raw">raw</option>
          </select>
          <div class="hint" id="bodyHint"></div>

          <label>Body</label>
          <textarea id="bodyText"></textarea>

          <div id="multipartFiles" class="subpanel" style="display:none">
            <div class="hint">multipart 中写 key=@file 会在这里生成文件选择器（字段名要匹配）。</div>
            <div id="fileInputs"></div>
          </div>

          <div id="rawFilePanel" class="subpanel" style="display:none">
            <div class="hint">raw 模式可上传文件作为 body（优先于文本）。</div>
            <input type="file" id="rawFile">
          </div>

          <div class="btns">
            <button id="btnSend">发送</button>
            <button class="secondary" id="btnApplyPresets">套预设</button>
            <button class="secondary" id="btnExportCurl">导出 cURL</button>
            <button class="danger" id="btnReset">清空</button>
          </div>

          <div id="sendMsg" class="msg"></div>
        </div>

        <!-- Presets tab -->
        <div class="tabpane" id="tab-presets" style="display:none">
          <div class="hint">
            预设保存在 localStorage。支持：<b>点击规则输入值</b>、key 改 Query/Headers/Body(kv)、<b>JSON Path</b> 修改、作用域过滤（域名/路径）。
          </div>

          <div class="subpanel">
            <div class="row">
              <div class="col-flex">
                <label>规则名（唯一）</label>
                <input id="psName">
              </div>
              <div class="col-220">
                <label>类型</label>
                <select id="psType">
                  <option value="kv">KV 改值（Query/Headers/Body-kv）</option>
                  <option value="jsonpath">JSON Path 改值（Body 为 JSON）</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div class="col-220">
                <label>目标</label>
                <select id="psTarget">
                  <option value="query">Query</option>
                  <option value="headers">Headers</option>
                  <option value="body_kv">Body(kv)</option>
                </select>
              </div>
              <div class="col-flex">
                <label>匹配 key / path</label>
                <input id="psMatch" placeholder="kv: realtime   /  jsonpath: data.realtime">
              </div>
            </div>

            <div class="row">
              <div class="col-flex">
                <label>默认替换值</label>
                <input id="psValue" placeholder="可留空：点击应用时会弹窗输入">
              </div>
              <div class="col-220">
                <label>点击应用时弹窗输入</label>
                <select id="psPrompt">
                  <option value="true">true</option>
                  <option value="false">false</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div class="col-flex">
                <label>作用域域名（可空，支持包含匹配）</label>
                <input id="psHost" placeholder="例如 api.example.com">
              </div>
              <div class="col-flex">
                <label>作用域路径（可空，支持包含匹配）</label>
                <input id="psPath" placeholder="例如 /v1/query">
              </div>
            </div>

            <div class="row">
              <div class="col-160">
                <label>启用</label>
                <select id="psEnabled">
                  <option value="true">true</option>
                  <option value="false">false</option>
                </select>
              </div>
              <div class="col-220">
                <label>解析后自动应用</label>
                <select id="psAuto">
                  <option value="true">true</option>
                  <option value="false">false</option>
                </select>
              </div>
            </div>

            <div class="btns">
              <button class="secondary" id="psSave">保存/更新</button>
              <button class="secondary" id="psClear">清空</button>
              <button id="psApply">一键应用（命中作用域）</button>
            </div>
          </div>

          <label>已保存规则</label>
          <div id="presetList" class="list"></div>

          <div class="btns">
            <button class="secondary" id="psExport">导出 JSON</button>
            <button class="secondary" id="psImport">导入 JSON</button>
            <button class="danger" id="psWipe">清空全部</button>
          </div>
          <textarea id="psIO" placeholder="导入/导出 JSON"></textarea>
        </div>

        <!-- Advanced tab -->
        <div class="tabpane" id="tab-adv" style="display:none">
          <div class="split">
            <div>
              <label>Timeout（秒）</label>
              <input id="timeout" type="number" min="1" max="120" value="20">
            </div>
            <div>
              <label>Redirects</label>
              <select id="allowRedirects">
                <option value="true">follow</option>
                <option value="false">no follow</option>
              </select>
            </div>
          </div>

          <div class="split">
            <div>
              <label>Verify SSL</label>
              <select id="verifySSL">
                <option value="true">true</option>
                <option value="false">false (-k)</option>
              </select>
            </div>
            <div>
              <label>Proxy（-x）</label>
              <input id="proxy" placeholder="http://127.0.0.1:7890">
            </div>
          </div>

          <div class="split">
            <div>
              <label>Basic Auth（-u）</label>
              <input id="authUser" placeholder="user:pass">
            </div>
            <div>
              <label>Cookies（-b）</label>
              <input id="cookies" placeholder="a=1; b=2">
            </div>
          </div>

          <div class="hint">
            安全：默认禁止访问内网/localhost/保留网段，并且重定向后再次校验最终 URL。
          </div>
        </div>
      </div>
    </section>
  </div>
</main>

<!-- Mobile bottom bar -->
<div class="mobilebar">
  <button class="secondary" id="mParse">解析</button>
  <button class="secondary" id="mPresets">套预设</button>
  <button id="mSend">发送</button>
</div>

<!-- Response drawer -->
<div class="drawer" id="drawer">
  <div class="drawer-hd">
    <div>
      <div class="drawer-title">Response</div>
      <div class="drawer-meta" id="respMeta"></div>
    </div>
    <div class="drawer-actions">
      <button class="secondary" id="btnDownload">下载</button>
      <button class="secondary" id="btnToggleView">预览/源码</button>
      <button class="secondary" id="btnCloseDrawer">关闭</button>
    </div>
  </div>
  <div class="drawer-body">
    <div class="resp-top">
      <span class="status" id="respStatus"></span>
      <span class="small" id="respUrl"></span>
    </div>

    <div class="resp-split">
      <div>
        <div class="subttl">Headers</div>
        <pre id="respHeaders"></pre>
      </div>
      <div>
        <div class="subttl">Body</div>
        <pre id="respBody"></pre>
        <div id="htmlPreview" class="html-preview" style="display:none"></div>
      </div>
    </div>

    <div class="hint" id="respHint"></div>
  </div>
</div>
<div class="backdrop" id="backdrop"></div>

<script src="/static/app.js"></script>
</body>
</html>
```

---

## static/app.css

```css
:root{
  --bg:#0b1020; --panel:rgba(255,255,255,.06);
  --stroke:rgba(255,255,255,.12); --text:rgba(255,255,255,.92); --muted:rgba(255,255,255,.65);
  --brand:#6ea8fe; --ok:#7ee787; --danger:#ff7b72;
  --shadow: 0 10px 30px rgba(0,0,0,.35);
  --radius:16px;
}

*{box-sizing:border-box}
body{
  margin:0; color:var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  background:
    radial-gradient(1200px 600px at 10% 10%, rgba(110,168,254,.18), transparent 55%),
    radial-gradient(1000px 600px at 90% 20%, rgba(126,231,135,.14), transparent 60%),
    radial-gradient(1000px 800px at 50% 120%, rgba(255,123,114,.10), transparent 60%),
    var(--bg);
  min-height:100vh;
}

.header{
  position:sticky; top:0; z-index:10;
  backdrop-filter: blur(10px);
  background: linear-gradient(to bottom, rgba(11,16,32,.9), rgba(11,16,32,.55));
  border-bottom:1px solid var(--stroke);
}
.wrap{max-width:1200px; margin:0 auto; padding:18px;}
.topbar{display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap}
.brand{display:flex; align-items:center; gap:10px; font-weight:900;}
.logo{
  width:34px;height:34px;border-radius:12px;
  background: linear-gradient(135deg, rgba(110,168,254,1), rgba(126,231,135,1));
  box-shadow: var(--shadow);
}
.brand-title{font-size:16px; font-weight:1000;}
.hint{color:var(--muted); font-size:13px; line-height:1.45}
.right-hint{max-width:420px; text-align:right}

.grid{display:grid; grid-template-columns: 1.05fr 1.35fr; gap:14px; margin-top:14px;}
@media (max-width: 980px){ .grid{grid-template-columns:1fr} }

.card{
  background: linear-gradient(180deg, var(--panel), rgba(255,255,255,.04));
  border:1px solid var(--stroke);
  border-radius:var(--radius);
  box-shadow: var(--shadow);
  overflow:hidden;
}
.card-hd{
  padding:14px; border-bottom:1px solid var(--stroke);
  display:flex; align-items:center; justify-content:space-between; gap:10px;
}
.title{font-weight:1000}
.pill{
  font-size:12px; color:rgba(255,255,255,.85);
  border:1px solid var(--stroke); background: rgba(255,255,255,.05);
  padding:6px 10px; border-radius:999px; white-space:nowrap;
}
.card-body{padding:14px;}

label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
input, select, textarea, button{
  width:100%;
  border-radius:14px;
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.05);
  color: var(--text);
  padding:11px 12px;
  outline:none;
}
textarea{min-height:120px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
input:focus, select:focus, textarea:focus{border-color: rgba(110,168,254,.6); box-shadow: 0 0 0 3px rgba(110,168,254,.15);}

.btns{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
button{
  cursor:pointer;
  font-weight:1000;
  border:1px solid rgba(110,168,254,.55);
  background: linear-gradient(135deg, rgba(110,168,254,.9), rgba(110,168,254,.65));
}
button.secondary{
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.06);
}
button.danger{
  border:1px solid rgba(255,123,114,.55);
  background: rgba(255,123,114,.18);
}
button:disabled{opacity:.55; cursor:not-allowed;}
.full{margin-top:10px}

.row{display:flex; gap:10px; flex-wrap:wrap}
.col-160{flex:0 0 160px; min-width:160px}
.col-220{flex:0 0 220px; min-width:220px}
.col-flex{flex:1; min-width:240px}
.split{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
@media (max-width: 980px){ .split{grid-template-columns:1fr} }

.sep{border:none;border-top:1px solid var(--stroke); margin:14px 0;}

.msg{margin-top:10px; font-size:12px; color:var(--muted)}
.msg .ok{color:var(--ok); font-weight:1000}
.msg .err{color:var(--danger); font-weight:1000}

.tabs{display:flex; gap:8px; flex-wrap:wrap}
.tab{
  width:auto;
  padding:7px 10px; border-radius:999px;
  border:1px solid var(--stroke); background: rgba(255,255,255,.04);
  cursor:pointer; user-select:none; font-size:13px; font-weight:1000; color:rgba(255,255,255,.82);
}
.tab.active{border-color: rgba(110,168,254,.65); background: rgba(110,168,254,.18); color:rgba(255,255,255,.95)}

.kv{
  border:1px solid var(--stroke);
  background: rgba(0,0,0,.18);
  border-radius:14px; overflow:hidden;
}
.kvrow{
  display:grid; grid-template-columns: 1fr 1fr 44px;
  gap:8px; padding:8px; border-top:1px solid rgba(255,255,255,.08);
}
.kvrow:first-child{border-top:none}
.kvrow input{
  padding:10px 10px; border-radius:12px;
  background: rgba(255,255,255,.05);
}
.iconbtn{
  width:44px; padding:0; border-radius:12px;
  background: rgba(255,255,255,.06); border:1px solid var(--stroke);
  display:flex; align-items:center; justify-content:center;
  font-weight:1000;
}

.list{margin-top:10px; display:flex; flex-direction:column; gap:10px}
.item{
  border:1px solid var(--stroke);
  background: rgba(0,0,0,.18);
  border-radius:14px;
  padding:10px;
}
.item-title{display:flex; justify-content:space-between; gap:10px; align-items:center; font-weight:1000}
.item-meta{font-size:12px; color:var(--muted); margin-top:6px; line-height:1.4}
.item-actions{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap}
.item-actions button{width:auto; padding:8px 10px; border-radius:12px}

.subpanel{
  border:1px solid var(--stroke);
  background: rgba(0,0,0,.18);
  border-radius:14px;
  padding:10px;
  margin-top:10px;
}

/* mobile bottom bar */
.mobilebar{
  position: fixed;
  left: 0; right: 0; bottom: 0;
  padding: 10px 12px;
  background: linear-gradient(to top, rgba(11,16,32,.98), rgba(11,16,32,.60));
  border-top: 1px solid var(--stroke);
  backdrop-filter: blur(10px);
  display:none;
  gap:10px;
  z-index: 50;
}
.mobilebar button{height:46px;}
@media (max-width: 680px){
  .wrap{padding:12px;}
  .card-body{padding:12px;}
  textarea{min-height:140px;}
  .mobilebar{display:flex;}
  body{padding-bottom:78px;}
  .right-hint{text-align:left}
}

/* Response drawer */
.drawer{
  position: fixed;
  left: 0; right: 0; bottom: -100%;
  background: rgba(11,16,32,.98);
  border-top:1px solid var(--stroke);
  box-shadow: 0 -10px 30px rgba(0,0,0,.45);
  z-index: 60;
  transition: bottom .25s ease;
  max-height: 85vh;
  display:flex;
  flex-direction:column;
}
.drawer.open{bottom:0;}
.drawer-hd{
  padding:12px;
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:10px;
  border-bottom:1px solid var(--stroke);
}
.drawer-title{font-weight:1000}
.drawer-meta{font-size:12px; color:var(--muted); margin-top:4px}
.drawer-actions{display:flex; gap:8px; flex-wrap:wrap}
.drawer-actions button{width:auto; padding:8px 10px; border-radius:12px}

.drawer-body{padding:12px; overflow:auto}
.resp-top{display:flex; flex-direction:column; gap:6px; margin-bottom:10px}
.status{font-weight:1000}
.small{font-size:12px; color:var(--muted)}
.resp-split{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
@media (max-width: 980px){ .resp-split{grid-template-columns:1fr} }

.subttl{font-size:12px; color:var(--muted); margin:6px 0}
pre{
  margin:0; padding:12px;
  border-radius:14px;
  border:1px solid var(--stroke);
  background: rgba(0,0,0,.22);
  white-space:pre-wrap; word-break:break-word;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size:13px;
}
.html-preview{
  border:1px solid var(--stroke);
  background:#fff;
  color:#111;
  border-radius:14px;
  padding:12px;
  margin-top:10px;
}
.backdrop{
  position: fixed;
  left:0; right:0; top:0; bottom:0;
  background: rgba(0,0,0,.35);
  z-index: 55;
  display:none;
}
.backdrop.show{display:block;}
```

---

## static/app.js

```js
// ========= utilities =========
const $ = (id) => document.getElementById(id);
const esc = (s) => String(s||'')
  .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
  .replaceAll('"','&quot;').replaceAll("'","&#039;");

function nowTs(){ return new Date().toISOString(); }

function parseHostPath(url){
  try{
    const u = new URL(url);
    return {host: u.host, path: u.pathname};
  }catch{ return {host:'', path:''}; }
}

// ========= KV editor =========
function kvAdd(container, k='', v=''){
  const c = $(container);
  const row = document.createElement('div');
  row.className = 'kvrow';
  row.innerHTML = `
    <input placeholder="key" value="${esc(k)}"/>
    <input placeholder="value" value="${esc(v)}"/>
    <button class="iconbtn" type="button">×</button>
  `;
  row.querySelector('button').onclick = () => row.remove();
  c.appendChild(row);
}

function kvSet(container, pairs){
  $(container).innerHTML = '';
  (pairs||[]).forEach(([k,v])=>kvAdd(container,k,v));
  if(!pairs || pairs.length===0) kvAdd(container,'','');
}

function kvGet(container){
  const rows = [...$(container).querySelectorAll('.kvrow')];
  const out = [];
  rows.forEach(r=>{
    const k = r.children[0].value.trim();
    const v = r.children[1].value;
    if(k) out.push([k,v]);
  });
  return out;
}

function kvFromText(text, mode){
  const lines = (text||'').split('\n').map(x=>x.trim()).filter(Boolean).filter(x=>!x.startsWith('#'));
  const pairs = [];
  if(mode==='headers'){
    lines.forEach(line=>{
      const idx = line.indexOf(':');
      if(idx<0) return;
      pairs.push([line.slice(0,idx).trim(), line.slice(idx+1).trim()]);
    });
  }else{
    lines.forEach(line=>{
      const idx = line.indexOf('=');
      if(idx<0) pairs.push([line,'']);
      else pairs.push([line.slice(0,idx).trim(), line.slice(idx+1).trim()]);
    });
  }
  return pairs;
}

function kvToText(pairs, mode){
  if(mode==='headers') return (pairs||[]).map(([k,v])=>`${k}: ${v}`).join('\n');
  return (pairs||[]).map(([k,v])=>`${k}=${v}`).join('\n');
}

// ========= Tabs =========
function setTab(name){
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.classList.toggle('active', btn.dataset.tab===name);
  });
  ['req','presets','adv'].forEach(t=>{
    $(`tab-${t}`).style.display = (t===name) ? 'block' : 'none';
  });
}

document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=> setTab(btn.dataset.tab));
});

// ========= Body mode UI =========
function updateBodyUI(){
  const mode = $('bodyMode').value;
  const hint = $('bodyHint');
  const multi = $('multipartFiles');
  const raw = $('rawFilePanel');

  if(mode==='json') hint.innerHTML = '粘贴 JSON；结构化解析发送。支持 JSON Path 预设改值。';
  else if(mode==='form-urlencoded') hint.innerHTML = '每行 key=value，以 x-www-form-urlencoded 发送。';
  else if(mode==='multipart') hint.innerHTML = '每行 key=value 或 key=@file；@file 会生成上传控件。';
  else if(mode==='raw') hint.innerHTML = '原样发送文本；也可上传文件作为 body。';
  else hint.innerHTML = '不发送请求体。';

  multi.style.display = (mode==='multipart') ? 'block' : 'none';
  raw.style.display = (mode==='raw') ? 'block' : 'none';

  if(mode==='multipart') refreshMultipartFileInputs();
}

function refreshMultipartFileInputs(){
  const body = $('bodyText').value || '';
  const keys = [];
  body.split('\n').map(x=>x.trim()).filter(Boolean).forEach(line=>{
    const idx = line.indexOf('=');
    if(idx<0) return;
    const k = line.slice(0,idx).trim();
    const v = line.slice(idx+1).trim();
    if(k && v.startsWith('@')) keys.push(k);
  });
  const box = $('fileInputs');
  box.innerHTML = '';
  if(keys.length===0){
    box.innerHTML = `<div class="hint">未检测到 @file 字段。</div>`;
    return;
  }
  keys.forEach(k=>{
    const div = document.createElement('div');
    div.style.marginTop = '8px';
    div.innerHTML = `
      <label>Upload file for field: <b>${esc(k)}</b></label>
      <input type="file" data-filekey="${esc(k)}"/>
    `;
    box.appendChild(div);
  });
}

$('bodyMode').addEventListener('change', updateBodyUI);
$('bodyText').addEventListener('input', ()=> {
  if($('bodyMode').value==='multipart') refreshMultipartFileInputs();
});

// ========= Presets =========
const PRESET_KEY = 'httpstudio_presets_v2';

function loadPresets(){
  try{ return JSON.parse(localStorage.getItem(PRESET_KEY) || '[]'); }catch{ return []; }
}
function savePresets(arr){
  localStorage.setItem(PRESET_KEY, JSON.stringify(arr||[]));
}
function presetClear(){
  $('psName').value='';
  $('psType').value='kv';
  $('psTarget').value='query';
  $('psMatch').value='';
  $('psValue').value='';
  $('psPrompt').value='true';
  $('psHost').value='';
  $('psPath').value='';
  $('psEnabled').value='true';
  $('psAuto').value='true';
}

function presetUpsert(){
  const name = $('psName').value.trim();
  if(!name) return alert('规则名不能为空');
  const item = {
    name,
    type: $('psType').value,
    target: $('psTarget').value,
    match: $('psMatch').value.trim(),
    value: $('psValue').value,
    prompt: $('psPrompt').value==='true',
    scopeHost: $('psHost').value.trim(),
    scopePath: $('psPath').value.trim(),
    enabled: $('psEnabled').value==='true',
    auto: $('psAuto').value==='true',
  };
  if(!item.match) return alert('匹配 key/path 不能为空');

  const list = loadPresets();
  const idx = list.findIndex(x=>x.name===name);
  if(idx>=0) list[idx]=item; else list.push(item);
  savePresets(list);
  renderPresetList();
  presetClear();
}

function renderPresetList(){
  const list = loadPresets();
  const box = $('presetList');
  box.innerHTML = '';
  if(list.length===0){
    box.innerHTML = `<div class="item"><div class="item-meta">暂无预设规则。</div></div>`;
    return;
  }

  list.forEach(p=>{
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <div class="item-title">
        <span>${esc(p.name)} ${p.enabled ? '' : '(OFF)'} ${p.auto ? '• auto' : ''}</span>
        <span class="pill">${esc(p.type)}</span>
      </div>
      <div class="item-meta">
        target=<b>${esc(p.target)}</b> · match=<b>${esc(p.match)}</b> · prompt=${p.prompt ? 'true':'false'}<br/>
        scope: host=${esc(p.scopeHost||'*')} path=${esc(p.scopePath||'*')}
      </div>
      <div class="item-actions">
        <button class="secondary" data-act="load">编辑</button>
        <button class="secondary" data-act="toggle">${p.enabled?'禁用':'启用'}</button>
        <button class="secondary" data-act="apply">应用</button>
        <button class="danger" data-act="del">删除</button>
      </div>
    `;
    div.querySelector('[data-act="load"]').onclick = ()=>{
      $('psName').value=p.name;
      $('psType').value=p.type;
      $('psTarget').value=p.target;
      $('psMatch').value=p.match;
      $('psValue').value=p.value || '';
      $('psPrompt').value=p.prompt ? 'true':'false';
      $('psHost').value=p.scopeHost || '';
      $('psPath').value=p.scopePath || '';
      $('psEnabled').value=p.enabled ? 'true':'false';
      $('psAuto').value=p.auto ? 'true':'false';
      setTab('presets');
    };
    div.querySelector('[data-act="toggle"]').onclick = ()=>{
      const list2 = loadPresets();
      const idx = list2.findIndex(x=>x.name===p.name);
      if(idx>=0){ list2[idx].enabled = !list2[idx].enabled; savePresets(list2); renderPresetList(); }
    };
    div.querySelector('[data-act="del"]').onclick = ()=>{
      if(!confirm('删除该规则？')) return;
      savePresets(loadPresets().filter(x=>x.name!==p.name));
      renderPresetList();
    };
    div.querySelector('[data-act="apply"]').onclick = ()=> applyPresets([p], true);

    box.appendChild(div);
  });
}

function exportPresets(){
  $('psIO').value = JSON.stringify(loadPresets(), null, 2);
}
function importPresets(){
  try{
    const arr = JSON.parse($('psIO').value || '[]');
    if(!Array.isArray(arr)) throw new Error('必须是数组');
    savePresets(arr);
    renderPresetList();
    alert('导入成功');
  }catch(e){
    alert('导入失败：' + (e.message||String(e)));
  }
}
function wipePresets(){
  if(confirm('清空全部预设？')){
    savePresets([]);
    renderPresetList();
  }
}

function scopeMatch(preset, url){
  const {host, path} = parseHostPath(url);
  if(preset.scopeHost && !host.includes(preset.scopeHost)) return false;
  if(preset.scopePath && !path.includes(preset.scopePath)) return false;
  return true;
}

// JSON path setter (simple dot path, supports arrays by [n] like items[0].id)
function setJsonPath(obj, path, value){
  const parts = path.split('.').filter(Boolean);
  let cur = obj;
  for(let i=0;i<parts.length;i++){
    const part = parts[i];
    const m = part.match(/^(\w+)\[(\d+)\]$/);
    if(m){
      const key = m[1], idx = parseInt(m[2],10);
      if(i===parts.length-1){
        if(!Array.isArray(cur[key])) cur[key]=[];
        cur[key][idx]=value;
        return true;
      }else{
        if(!Array.isArray(cur[key])) cur[key]=[];
        if(cur[key][idx] == null) cur[key][idx] = {};
        cur = cur[key][idx];
      }
    }else{
      if(i===parts.length-1){
        cur[part]=value;
        return true;
      }else{
        if(cur[part] == null || typeof cur[part] !== 'object') cur[part] = {};
        cur = cur[part];
      }
    }
  }
  return false;
}

function applyPresets(presets=null, showMsg=false, onlyAuto=false){
  // get enabled presets
  let list = presets ? presets : loadPresets();
  list = list.filter(p=>p.enabled);
  if(onlyAuto) list = list.filter(p=>p.auto);

  const url = $('url').value.trim();
  list = list.filter(p=>scopeMatch(p, url));

  if(list.length===0){
    if(showMsg) $('sendMsg').innerHTML = `<span class="err">没有命中可用预设（检查启用/作用域）。</span>`;
    return;
  }

  // sync from kv to text (keep both coherent)
  const qPairs = kvGet('kvQuery');
  const hPairs = kvGet('kvHeaders');
  let bodyMode = $('bodyMode').value;
  let bodyText = $('bodyText').value || '';

  const setKV = (pairs, key, newVal)=>{
    let hit = false;
    const out = pairs.map(([k,v])=>{
      if(k===key){ hit=true; return [k,newVal]; }
      return [k,v];
    });
    if(!hit) out.push([key,newVal]);
    return {out, hit: true};
  };

  let hits = 0;
  let newQ = qPairs;
  let newH = hPairs;
  let newBody = bodyText;

  for(const p of list){
    let val = p.value ?? '';
    if(p.prompt){
      const typed = prompt(`输入 ${p.name} 的值：`, val);
      if(typed === null) continue;
      val = typed;
    }

    if(p.type === 'kv'){
      if(p.target === 'query'){
        newQ = setKV(newQ, p.match, val).out; hits++;
      }else if(p.target === 'headers'){
        newH = setKV(newH, p.match, val).out; hits++;
      }else if(p.target === 'body_kv'){
        if(bodyMode !== 'form-urlencoded' && bodyMode !== 'multipart') continue;
        const lines = newBody.split('\n');
        let found = false;
        const out = lines.map(line=>{
          const t = line.trim(); if(!t) return line;
          const idx = t.indexOf('=');
          if(idx<0) return line;
          const k = t.slice(0,idx).trim();
          if(k===p.match){ found=true; return `${k}=${val}`; }
          return line;
        });
        if(!found) out.push(`${p.match}=${val}`);
        newBody = out.join('\n');
        hits++;
      }
    } else if(p.type === 'jsonpath'){
      if(bodyMode !== 'json') continue;
      try{
        const obj = JSON.parse(newBody || '{}');
        setJsonPath(obj, p.match, val);
        newBody = JSON.stringify(obj, null, 2);
        hits++;
      }catch{
        // ignore invalid json
      }
    }
  }

  kvSet('kvQuery', newQ);
  kvSet('kvHeaders', newH);
  $('queryText').value = kvToText(newQ, 'kv');
  $('headersText').value = kvToText(newH, 'headers');
  $('bodyText').value = newBody;

  if($('bodyMode').value === 'multipart') refreshMultipartFileInputs();
  if(showMsg) $('sendMsg').innerHTML = `<span class="ok">已应用预设：</span>命中 ${hits} 处。`;
}

// ========= History / Favorites =========
const HISTORY_KEY = 'httpstudio_history_v1';
const STAR_KEY = 'httpstudio_star_v1';

function loadList(key){
  try{ return JSON.parse(localStorage.getItem(key) || '[]'); }catch{ return []; }
}
function saveList(key, arr){
  localStorage.setItem(key, JSON.stringify(arr||[]));
}
function snapshotRequest(){
  // keep both forms consistent
  const qPairs = kvGet('kvQuery');
  const hPairs = kvGet('kvHeaders');
  return {
    ts: nowTs(),
    method: $('method').value,
    url: $('url').value.trim(),
    query_pairs: qPairs,
    headers_pairs: hPairs,
    queryText: $('queryText').value,
    headersText: $('headersText').value,
    bodyMode: $('bodyMode').value,
    bodyText: $('bodyText').value,
    timeout: $('timeout').value,
    allowRedirects: $('allowRedirects').value,
    verifySSL: $('verifySSL').value,
    proxy: $('proxy').value,
    authUser: $('authUser').value,
    cookies: $('cookies').value,
  };
}
function loadSnapshot(s){
  $('method').value = s.method || 'GET';
  $('url').value = s.url || '';
  kvSet('kvQuery', s.query_pairs || []);
  kvSet('kvHeaders', s.headers_pairs || []);
  $('queryText').value = s.queryText || kvToText(s.query_pairs||[], 'kv');
  $('headersText').value = s.headersText || kvToText(s.headers_pairs||[], 'headers');
  $('bodyMode').value = s.bodyMode || 'none';
  $('bodyText').value = s.bodyText || '';
  $('timeout').value = s.timeout || 20;
  $('allowRedirects').value = s.allowRedirects || 'true';
  $('verifySSL').value = s.verifySSL || 'true';
  $('proxy').value = s.proxy || '';
  $('authUser').value = s.authUser || '';
  $('cookies').value = s.cookies || '';
  updateBodyUI();
}

function renderHistory(){
  const q = ($('historySearch').value||'').toLowerCase().trim();
  const hist = loadList(HISTORY_KEY);
  const stars = loadList(STAR_KEY);
  const all = [...stars.map(x=>({...x, _star:true})), ...hist.map(x=>({...x, _star:false}))];

  const filtered = q ? all.filter(s=>{
    const hay = `${s.method} ${s.url} ${s.ts}`.toLowerCase();
    return hay.includes(q);
  }) : all;

  const box = $('historyList');
  box.innerHTML = '';
  if(filtered.length===0){
    box.innerHTML = `<div class="item"><div class="item-meta">暂无记录。</div></div>`;
    return;
  }

  filtered.slice(0, 50).forEach(s=>{
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <div class="item-title">
        <span>${s._star ? '⭐ ' : ''}${esc(s.method)} ${esc(s.url)}</span>
        <span class="pill">${esc(new Date(s.ts).toLocaleString())}</span>
      </div>
      <div class="item-meta">body=${esc(s.bodyMode)} · q=${(s.query_pairs||[]).length} · h=${(s.headers_pairs||[]).length}</div>
      <div class="item-actions">
        <button class="secondary" data-act="load">回放</button>
        <button class="secondary" data-act="send">回放并发送</button>
        <button class="danger" data-act="del">删除</button>
      </div>
    `;
    div.querySelector('[data-act="load"]').onclick = ()=> loadSnapshot(s);
    div.querySelector('[data-act="send"]').onclick = ()=>{
      loadSnapshot(s);
      sendNow();
    };
    div.querySelector('[data-act="del"]').onclick = ()=>{
      if(!confirm('删除该条？')) return;
      if(s._star){
        saveList(STAR_KEY, loadList(STAR_KEY).filter(x=>x.ts!==s.ts));
      }else{
        saveList(HISTORY_KEY, loadList(HISTORY_KEY).filter(x=>x.ts!==s.ts));
      }
      renderHistory();
    };
    box.appendChild(div);
  });
}

// ========= Response drawer =========
let drawerOpen = false;
let lastDownloadId = null;
let previewMode = 'code'; // code or html
function openDrawer(){
  $('drawer').classList.add('open');
  $('backdrop').classList.add('show');
  drawerOpen = true;
}
function closeDrawer(){
  $('drawer').classList.remove('open');
  $('backdrop').classList.remove('show');
  drawerOpen = false;
}
$('btnCloseDrawer').onclick = closeDrawer;
$('backdrop').onclick = closeDrawer;

$('btnToggleView').onclick = ()=>{
  previewMode = (previewMode === 'code') ? 'html' : 'code';
  $('htmlPreview').style.display = (previewMode === 'html') ? 'block' : 'none';
  $('respBody').style.display = (previewMode === 'html') ? 'none' : 'block';
};

$('btnDownload').onclick = ()=>{
  if(!lastDownloadId) return alert('没有可下载内容');
  window.open(`/api/download/${lastDownloadId}`, '_blank');
};

function renderResponse(resp){
  lastDownloadId = resp.download_id || null;

  const ok = !!resp.ok;
  $('respStatus').textContent = `${resp.status_code} ${resp.reason||''}`.trim();
  $('respStatus').style.color = ok ? 'var(--ok)' : 'var(--danger)';
  $('respUrl').textContent = resp.final_url || '';
  $('respHeaders').textContent = resp.headers_text || '';
  $('respBody').textContent = resp.body_text || '';
  $('respMeta').textContent = `耗时 ${resp.elapsed_ms} ms · size ${resp.body_len} bytes` + (resp.truncated ? ' · 预览已截断' : '');
  $('respHint').textContent = resp.truncated ? '提示：响应预览已截断（安全限制）。可用下载按钮获取完整内容（同样可能受预览限制）。' : '';

  // HTML preview
  const ct = (resp.content_type || '').toLowerCase();
  if(ct.includes('text/html')){
    $('htmlPreview').innerHTML = resp.body_text || '';
    $('btnToggleView').style.display = 'inline-block';
  }else{
    $('htmlPreview').innerHTML = '';
    $('btnToggleView').style.display = 'none';
    previewMode = 'code';
    $('htmlPreview').style.display = 'none';
    $('respBody').style.display = 'block';
  }

  openDrawer();
}

// ========= Send (AJAX + AbortController) =========
let currentAbort = null;

function setSending(isSending){
  $('btnSend').disabled = isSending;
  $('btnSend').textContent = isSending ? '发送中…（点我取消）' : '发送';
}

async function sendNow(){
  // sync text areas with kv
  const qPairs = kvGet('kvQuery');
  const hPairs = kvGet('kvHeaders');
  $('queryText').value = kvToText(qPairs, 'kv');
  $('headersText').value = kvToText(hPairs, 'headers');

  $('sendMsg').innerHTML = `<span class="ok">发送中…</span>`;
  // allow cancel by clicking send button again
  if(currentAbort){
    currentAbort.abort();
    currentAbort = null;
    $('sendMsg').innerHTML = `<span class="err">已取消（前端）</span>`;
    setSending(false);
    return;
  }

  currentAbort = new AbortController();
  setSending(true);

  const fd = new FormData();
  fd.append('method', $('method').value);
  fd.append('url', $('url').value);
  fd.append('query_params', $('queryText').value);
  fd.append('headers', $('headersText').value);
  fd.append('body_mode', $('bodyMode').value);
  fd.append('body_text', $('bodyText').value);
  fd.append('timeout', $('timeout').value);
  fd.append('verify_ssl', $('verifySSL').value);
  fd.append('allow_redirects', $('allowRedirects').value);
  fd.append('proxy', $('proxy').value);
  fd.append('auth_user', $('authUser').value);
  fd.append('cookies', $('cookies').value);

  if($('bodyMode').value === 'multipart'){
    document.querySelectorAll('#fileInputs input[type="file"]').forEach(inp=>{
      const key = inp.dataset.filekey;
      if(inp.files && inp.files[0]) fd.append(key, inp.files[0]);
    });
  }
  if($('bodyMode').value === 'raw'){
    if($('rawFile').files && $('rawFile').files[0]) fd.append('__raw_file__', $('rawFile').files[0]);
  }

  try{
    const res = await fetch('/api/send', {method:'POST', body: fd, signal: currentAbort.signal});
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || '发送失败');
    $('sendMsg').innerHTML = `<span class="ok">成功：</span>${data.status_code} ${esc(data.reason||'')}`;
    renderResponse(data);
    // auto save to history
    const hist = loadList(HISTORY_KEY);
    hist.unshift(snapshotRequest());
    saveList(HISTORY_KEY, hist.slice(0, 80));
    renderHistory();
  }catch(e){
    $('sendMsg').innerHTML = `<span class="err">失败：</span>${esc(e.message||String(e))}`;
  }finally{
    currentAbort = null;
    setSending(false);
  }
}

// ========= cURL parse =========
async function parseCurl(){
  const curl = $('curlText').value || '';
  $('parseMsg').innerHTML = '';
  try{
    const res = await fetch('/api/parse_curl', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({curl})
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || '解析失败');

    $('method').value = data.method || 'GET';
    $('url').value = data.url || '';
    kvSet('kvQuery', data.query_pairs || []);
    kvSet('kvHeaders', Object.entries(data.headers || {}));
    $('queryText').value = kvToText(kvGet('kvQuery'), 'kv');
    $('headersText').value = kvToText(kvGet('kvHeaders'), 'headers');
    $('bodyMode').value = data.body_mode || 'none';
    $('bodyText').value = data.body_text || '';
    $('timeout').value = data.timeout || 20;
    $('verifySSL').value = data.insecure ? 'false' : 'true';
    $('allowRedirects').value = data.follow_redirects ? 'true' : 'false';
    $('proxy').value = data.proxy || '';
    $('authUser').value = data.auth_user || '';
    $('cookies').value = data.cookies || '';

    updateBodyUI();

    // auto apply presets (enabled+auto & scope match)
    applyPresets(null, false, true);

    $('parseMsg').innerHTML = `<span class="ok">解析成功</span>（已自动套用 auto 预设）`;
    setTab('req');
  }catch(e){
    $('parseMsg').innerHTML = `<span class="err">解析失败：</span>${esc(e.message||String(e))}`;
  }
}

function fillExample(){
  $('curlText').value =
`curl 'https://httpbin.org/post?x=1' \\
  -X POST \\
  -H 'content-type: application/json' \\
  -H 'x-demo: 123' \\
  -b 'a=1; b=2' \\
  --data-raw '{"hello":"world","realtime":"00:11:00","data":{"realtime":"00:11:00"}}' \\
  -L -k -m 15`;
}

// ========= export curl =========
function exportCurl(){
  const qPairs = kvGet('kvQuery');
  const hPairs = kvGet('kvHeaders');
  const url = $('url').value.trim();
  const method = $('method').value;
  const query = kvToText(qPairs, 'kv').split('\n').map(x=>x.trim()).filter(Boolean).join('&');
  const headers = kvToText(hPairs, 'headers').split('\n').map(x=>x.trim()).filter(Boolean);
  const mode = $('bodyMode').value;
  const body = $('bodyText').value || '';

  let full = url;
  if(query) full += (url.includes('?') ? '&' : '?') + query;

  const parts = [`curl '${full.replaceAll("'", "\\'")}'`];
  if(method !== 'GET') parts.push(`-X ${method}`);
  headers.forEach(h=> parts.push(`-H '${h.replaceAll("'", "\\'")}'`));

  if(mode==='json' && body.trim()) parts.push(`--data-raw '${body.replaceAll("'", "\\'")}'`);
  if(mode==='form-urlencoded' && body.trim()){
    const flat = body.split('\n').map(x=>x.trim()).filter(Boolean).join('&');
    parts.push(`--data '${flat.replaceAll("'", "\\'")}'`);
  }
  if(mode==='raw' && body.trim()) parts.push(`--data-binary '${body.replaceAll("'", "\\'")}'`);
  if(mode==='multipart' && body.trim()){
    body.split('\n').map(x=>x.trim()).filter(Boolean).forEach(line=>{
      parts.push(`-F '${line.replaceAll("'", "\\'")}'`);
    });
  }

  const proxy = $('proxy').value.trim();
  if(proxy) parts.push(`-x '${proxy.replaceAll("'", "\\'")}'`);
  const auth = $('authUser').value.trim();
  if(auth) parts.push(`-u '${auth.replaceAll("'", "\\'")}'`);
  const cookies = $('cookies').value.trim();
  if(cookies) parts.push(`-b '${cookies.replaceAll("'", "\\'")}'`);
  if($('verifySSL').value==='false') parts.push(`-k`);
  if($('allowRedirects').value==='true') parts.push(`-L`);
  if($('timeout').value) parts.push(`-m ${$('timeout').value}`);

  navigator.clipboard.writeText(parts.join(' \\\n  '));
  $('sendMsg').innerHTML = `<span class="ok">已复制 cURL</span>`;
}

// ========= reset =========
function resetAll(){
  $('curlText').value='';
  $('method').value='GET';
  $('url').value='';
  kvSet('kvQuery',[['','']]);
  kvSet('kvHeaders',[['','']]);
  $('queryText').value='';
  $('headersText').value='';
  $('bodyMode').value='none';
  $('bodyText').value='';
  $('timeout').value=20;
  $('allowRedirects').value='true';
  $('verifySSL').value='true';
  $('proxy').value='';
  $('authUser').value='';
  $('cookies').value='';
  $('parseMsg').innerHTML='';
  $('sendMsg').innerHTML='';
  updateBodyUI();
}

// ========= wiring =========
$('btnExample').onclick = fillExample;
$('btnParse').onclick = parseCurl;
$('btnSend').onclick = sendNow;
$('btnApplyPresets').onclick = ()=> applyPresets(null, true, false);
$('btnExportCurl').onclick = exportCurl;
$('btnReset').onclick = resetAll;

$('qAdd').onclick = ()=> kvAdd('kvQuery');
$('hAdd').onclick = ()=> kvAdd('kvHeaders');
$('qSync').onclick = ()=> $('queryText').value = kvToText(kvGet('kvQuery'),'kv');
$('hSync').onclick = ()=> $('headersText').value = kvToText(kvGet('kvHeaders'),'headers');
$('qImport').onclick = ()=> kvSet('kvQuery', kvFromText($('queryText').value, 'kv'));
$('hImport').onclick = ()=> kvSet('kvHeaders', kvFromText($('headersText').value, 'headers'));

$('psSave').onclick = presetUpsert;
$('psClear').onclick = presetClear;
$('psApply').onclick = ()=> applyPresets(null, true, false);
$('psExport').onclick = exportPresets;
$('psImport').onclick = importPresets;
$('psWipe').onclick = wipePresets;

$('historySearch').addEventListener('input', renderHistory);
$('btnSaveHistory').onclick = ()=>{
  const hist = loadList(HISTORY_KEY);
  hist.unshift(snapshotRequest());
  saveList(HISTORY_KEY, hist.slice(0, 80));
  renderHistory();
};
$('btnSaveStar').onclick = ()=>{
  const stars = loadList(STAR_KEY);
  stars.unshift(snapshotRequest());
  saveList(STAR_KEY, stars.slice(0, 80));
  renderHistory();
};
$('btnClearHistory').onclick = ()=>{
  if(confirm('清空历史（不含收藏）？')){
    saveList(HISTORY_KEY, []);
    renderHistory();
  }
};

// mobile bar
$('mParse').onclick = parseCurl;
$('mPresets').onclick = ()=> applyPresets(null, true, false);
$('mSend').onclick = sendNow;

// init
(function init(){
  kvSet('kvQuery',[['','']]);
  kvSet('kvHeaders',[['','']]);
  updateBodyUI();
  renderPresetList();
  renderHistory();
  setTab('req');
})();
```

